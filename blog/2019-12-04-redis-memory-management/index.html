<!DOCTYPE html>
<html lang="">
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Hugo 0.91.2" />


<title>Rediså†…å­˜ç®¡ç† - åº„å…¨ğŸ¥š</title>
<meta property="og:title" content="Rediså†…å­˜ç®¡ç† - åº„å…¨ğŸ¥š">


  <link href='https://justzyx.github.io/favicon.ico' rel='icon' type='image/x-icon'/>



  




<link rel="icon" href="https://justzyx.github.io/images/favicon.ico" type="image/x-icon"/>
<link rel="stylesheet" href="https://justzyx.github.io/css/main.css" media="all">
<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Merriweather:400|Lato:400,400italic,700">

  </head>
  <body>
    <div class="wrapper">
      <header class="header">
        <nav class="nav">
  <a href="https://justzyx.github.io/" class="nav-logo">
    <img src="https://justzyx.github.io/images/logo.png" 
         width="50" 
         height="50" 
         alt="Logo">
  </a>

  <ul class="nav-links">
    
    
    <li><a href="/docs/" target="_blank">å…«è‚¡æ–‡</a></li>
    
    
    
    
    
    
    
    <li><a href="/gibberish/">è‡ªè¨€è‡ªè¯­</a></li>
    
    
    
    
    
    <li><a href="/about/">å…³äº</a></li>
    
    
  </ul>
</nav>
      </header>


<main class="content" role="main">

  <div class="toc" id="toc-auto">
      <h2 class="toc-title"></h2>
      <div class="toc-content always-active" id="toc-content-auto"></div>
  </div>

  <article class="article">
    
    <span class="article-duration">2 min read</span>
    

    
    <h1 class="article-title">Rediså†…å­˜ç®¡ç†</h1>
    

    
    <span class="article-date">December 2, 2019</span>
    

    <div class="article-content">
      <p>æœ¬æ–‡æºäºLeetCodeä¸Šé‡åˆ°çš„ä¸€é“é¢˜<a href="https://leetcode.com/problems/lru-cache/">LRU Cache</a>, ç¬¬ä¸€æ¬¡å¬è¯´LRUè¿™ä¸ªè¯è¿˜æ˜¯åœ¨å¤§ä¸‰æ“ä½œç³»ç»Ÿè¯¾ä¸Š, æ“ä½œç³»ç»Ÿåœ¨å‘ç”Ÿç¼ºé¡µå¼‚å¸¸ä¹‹åä¼šè¿›è¡Œé¡µé¢ç½®æ¢, LRUæ­£æ˜¯å‡ ä¸ªé¡µé¢ç½®æ¢ç®—æ³•ä¹‹ä¸€ã€‚æ­£å·§, Redisçš„å†…å­˜ç®¡ç†ä¹Ÿç”¨åˆ°äº†LRUç®—æ³•, æ•…å€Ÿæ­¤æœºä¼šæ‹“å±•å¼€æ¥é˜…è¯»ä¸€ä¸‹Rediså†…å­˜ç®¡ç†çš„æºç ä»¥åŠè¯¦ç»†ä»‹ç»ä¸€ä¸‹LRUç®—æ³•çš„å®ç°ã€‚</p>
<p>æœ¬æ–‡å‚è€ƒçš„æºç æ˜¯Redis 3.0</p>
<h2 id="é…ç½®é¡¹è¯´æ˜">
  é…ç½®é¡¹è¯´æ˜
  <a class="anchor" href="#%e9%85%8d%e7%bd%ae%e9%a1%b9%e8%af%b4%e6%98%8e">#</a>
</h2>
<p><code>redis.conf</code>ä¸­æœ‰ä¸¤ä¸ªå’Œå†…å­˜ç®¡ç†ç›¸å…³çš„é…ç½®é¡¹: <code>maxmemory</code> å’Œ <code>maxmemory-policy</code>ã€‚è¿™ä¸¤ä¸ªé…ç½®çš„ä¸»è¦æ„ä¹‰åœ¨äºæ§åˆ¶å†…å­˜çš„ç²¾ç»†åŒ–ä½¿ç”¨ï¼Œå°¤å…¶é€‚ç”¨äºå†·çƒ­æ•°æ®è¾ƒä¸ºæ˜æ˜¾çš„ä¸šåŠ¡åœºæ™¯ã€‚å¦‚è¯»å†™æ¯”è¶…è¿‡10:1çš„é«˜å¹¶å‘ç¼“å­˜ç³»ç»Ÿç­‰</p>
<h3 id="maxmemory">
  maxmemory
  <a class="anchor" href="#maxmemory">#</a>
</h3>
<p><code>maxmemory</code> å®šä¹‰äº†å¯ä¾›ä½¿ç”¨çš„æœ€å¤§å†…å­˜å­—èŠ‚æ•°ä¸Šé™, å½“è¾¾åˆ°è®¾å®šçš„é˜ˆå€¼å, Redisä¼šæ ¹æ®è®¾å®šçš„<code>maxmemory-policy</code>å†…å­˜é©±é€ç­–ç•¥å¯¹keysè¿›è¡Œæ¸…ç†.</p>
<p>æœ‰ä¸¤ä¸ªæ¯”è¾ƒå€¼å¾—å…³æ³¨çš„ç‚¹:</p>
<ul>
<li>ç¼ºçœå€¼æ˜¯0</li>
<li>é’ˆå¯¹32ä½æœºå™¨å†…å­˜ä¸ä¼šè¶…è¿‡4GBè¿™ä¸€ç‰¹æ€§,æ— è®ºè®¾ç½®çš„æ˜¯ä»€ä¹ˆ,Rediséƒ½æŠŠæœ€å¤§å¯ç”¨å†…å­˜å­—èŠ‚æ•°æ§åˆ¶åœ¨äº†3GBä¸”é»˜è®¤é€‰å–äº†<code>REDIS_MAXMEMORY_NO_EVICTION</code>è¿™ä¸€å†…å­˜é©±é€ç­–ç•¥</li>
</ul>
<p>ä»¥ä¸Šè®¨è®ºæ‰€æ¶‰åŠç›¸å…³ä»£ç ç‰‡æ®µå¦‚ä¸‹:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#75715e">//redis.h
</span><span style="color:#75715e"></span><span style="color:#66d9ef">struct</span> redisServer {
    ...
    <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span> <span style="color:#66d9ef">long</span> maxmemory;   <span style="color:#75715e">/* Max number of memory bytes to use */</span>
    <span style="color:#66d9ef">int</span> maxmemory_policy;           <span style="color:#75715e">/* Policy for key eviction */</span>
}

<span style="color:#75715e">#define REDIS_DEFAULT_MAXMEMORY 0
</span><span style="color:#75715e"></span>
<span style="color:#75715e">//å†…å­˜é©±é€ç­–ç•¥
</span><span style="color:#75715e"></span><span style="color:#75715e">#define REDIS_MAXMEMORY_VOLATILE_LRU 0
</span><span style="color:#75715e">#define REDIS_MAXMEMORY_VOLATILE_TTL 1
</span><span style="color:#75715e">#define REDIS_MAXMEMORY_VOLATILE_RANDOM 2
</span><span style="color:#75715e">#define REDIS_MAXMEMORY_ALLKEYS_LRU 3
</span><span style="color:#75715e">#define REDIS_MAXMEMORY_ALLKEYS_RANDOM 4
</span><span style="color:#75715e">#define REDIS_MAXMEMORY_NO_EVICTION 5
</span><span style="color:#75715e">#define REDIS_DEFAULT_MAXMEMORY_POLICY REDIS_MAXMEMORY_NO_EVICTION
</span><span style="color:#75715e"></span>
<span style="color:#75715e">//redis.c
</span><span style="color:#75715e"></span><span style="color:#66d9ef">struct</span> redisServer server; <span style="color:#75715e">/* server global state */</span>

<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">initServerConfig</span>() {
    server.arch_bits <span style="color:#f92672">=</span> (<span style="color:#66d9ef">sizeof</span>(<span style="color:#66d9ef">long</span>) <span style="color:#f92672">==</span> <span style="color:#ae81ff">8</span>) <span style="color:#f92672">?</span> <span style="color:#ae81ff">64</span> <span style="color:#f92672">:</span> <span style="color:#ae81ff">32</span>; <span style="color:#75715e">//32 or 64ä½æ¶æ„
</span><span style="color:#75715e"></span>    server.maxmemory <span style="color:#f92672">=</span> REDIS_DEFAULT_MAXMEMORY;
    server.maxmemory_policy <span style="color:#f92672">=</span> REDIS_DEFAULT_MAXMEMORY_POLICY; <span style="color:#75715e">//é»˜è®¤ä¸é©±é€
</span><span style="color:#75715e"></span>    ...
    <span style="color:#75715e">//é’ˆå¯¹32ä½æœºå™¨å†…å­˜ä¸ä¼šè¶…è¿‡4GBè¿™ä¸€ç‰¹æ€§,æ— è®ºè®¾ç½®çš„æ˜¯ä»€ä¹ˆ,Rediséƒ½æŠŠæœ€å¤§å¯ç”¨å†…å­˜å­—èŠ‚æ•°æ§åˆ¶åœ¨äº†3GBä¸”é»˜è®¤é€‰å–äº†`REDIS_MAXMEMORY_NO_EVICTION`è¿™ä¸€å†…å­˜é©±é€ç­–ç•¥
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> (server.arch_bits <span style="color:#f92672">==</span> <span style="color:#ae81ff">32</span> <span style="color:#f92672">&amp;&amp;</span> server.maxmemory <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) {
        redisLog(REDIS_WARNING,<span style="color:#e6db74">&#34;Warning: 32 bit instance detected but no memory limit set. Setting 3 GB maxmemory limit with &#39;noeviction&#39; policy now.&#34;</span>);
        server.maxmemory <span style="color:#f92672">=</span> <span style="color:#ae81ff">3072LL</span><span style="color:#f92672">*</span>(<span style="color:#ae81ff">1024</span><span style="color:#f92672">*</span><span style="color:#ae81ff">1024</span>); <span style="color:#75715e">/* 3 GB */</span>
        server.maxmemory_policy <span style="color:#f92672">=</span> REDIS_MAXMEMORY_NO_EVICTION;
    }
}
</code></pre></div><h3 id="maxmemory-policy">
  maxmemory-policy
  <a class="anchor" href="#maxmemory-policy">#</a>
</h3>
<p><code>maxmemory-policy</code>å®šä¹‰äº†å†…å­˜åœ¨è¾¾åˆ°<code>maxmemory</code>è§„å®šçš„å­—èŠ‚æ•°ä»¥åæ‰€ä½¿ç”¨çš„keyæ¸…ç†ç­–ç•¥, é»˜è®¤æ˜¯ä¸é©±é€(<code>noeviction</code>)ã€‚æœ‰å¦‚ä¸‹å…­ç§ç­–ç•¥ï¼š</p>
<ul>
<li>volatile-lru</li>
</ul>
<p>remove the key with an expire set using an LRU algorithm</p>
<p>å¯¹æ»¡è¶³LRUç®—æ³•ä¸”è®¾ç½®äº†è¿‡æœŸæ—¶é—´çš„keyè¿›è¡Œæ¸…ç†</p>
<ul>
<li>allkeys-lru</li>
</ul>
<p>remove any key accordingly to the LRU algorithm</p>
<p>å¯¹æ»¡è¶³LRUç®—æ³•çš„ä»»æ„keyè¿›è¡Œæ¸…ç†</p>
<ul>
<li>volatile-random</li>
</ul>
<p>remove a random key with an expire set</p>
<p>å¯¹è®¾ç½®äº†è¿‡æœŸçš„keyä»»æ„æ¸…ç†key</p>
<ul>
<li>allkeys-random</li>
</ul>
<p>remove a random key, any key</p>
<p>ä»»æ„keyéšæœºæ¸…ç†</p>
<ul>
<li>volatile-ttl</li>
</ul>
<p>remove the key with the nearest expire time (minor TTL)</p>
<p>æŒ‰ç…§å‰©ä½™è¿‡æœŸæ—¶é—´ä»å°åˆ°å¤§æ’åºä¾æ¬¡æ¸…ç†</p>
<ul>
<li>noeviction</li>
</ul>
<p>don&rsquo;t expire at all, just return an error on write operations</p>
<p>ä¸æ¸…ç†å†…å­˜ï¼Œä»…ä»…å¯¹å†™æ“ä½œæŠ¥é”™</p>
<h2 id="lru">
  LRU
  <a class="anchor" href="#lru">#</a>
</h2>
<p><a href="https://en.wikipedia.org/wiki/Cache_replacement_policies#Least_recently_used_%28LRU%29">LRU</a>(Least Recently Used)ï¼šæœ€è¿‘æœ€å°‘ä½¿ç”¨ç­–ç•¥ï¼Œè¨€å¤–ä¹‹æ„å°±æ˜¯æœ€è¿‘æ¯”è¾ƒå°‘ä½¿ç”¨çš„ä¼˜å…ˆæ·˜æ±°ã€‚</p>
<h3 id="æ€è·¯">
  æ€è·¯
  <a class="anchor" href="#%e6%80%9d%e8%b7%af">#</a>
</h3>
<ul>
<li>æ¶‰åŠåˆ°é¢‘ç¹çš„å†…å­˜è¿ç§»ï¼Œæ’å…¥åˆ é™¤æ“ä½œè¾ƒå¤šï¼Œç”¨é“¾è¡¨æ¥ç»´æŠ¤LRUç»“æ„</li>
<li>é’ˆå¯¹é“¾è¡¨æŸ¥æ‰¾O(N)çš„æ—¶é—´å¤æ‚åº¦åŠ£åŠ¿ï¼Œå¼•å…¥æ•£åˆ—è¡¨æ¥ç»´æŠ¤keyåœ¨é“¾è¡¨ä¸­çš„ä½ç½®</li>
</ul>
<p>æ—¶é—´å¤æ‚åº¦: O(1)</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c++" data-lang="c++"><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">LRUCache</span>
{
<span style="color:#66d9ef">private</span><span style="color:#f92672">:</span>
    list<span style="color:#f92672">&lt;</span>pair<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">int</span>, <span style="color:#66d9ef">int</span><span style="color:#f92672">&gt;&gt;</span> l; <span style="color:#75715e">//node =&gt; &lt;key,value&gt;
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">int</span> size; <span style="color:#75715e">//å½“å‰é•¿åº¦
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">int</span> cap; <span style="color:#75715e">//å¯å®¹çº³çš„å®¹é‡
</span><span style="color:#75715e"></span>    unordered_map<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">int</span>, list<span style="color:#f92672">&lt;</span>pair<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">int</span>, <span style="color:#66d9ef">int</span><span style="color:#f92672">&gt;&gt;::</span>iterator<span style="color:#f92672">&gt;</span> um; <span style="color:#75715e">// &lt;key, keyåœ¨é“¾è¡¨ä¸­è¿­ä»£å™¨ä½ç½®&gt;
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">public</span><span style="color:#f92672">:</span>
    LRUCache(<span style="color:#66d9ef">int</span> capacity) {
        <span style="color:#66d9ef">this</span><span style="color:#f92672">-&gt;</span>cap <span style="color:#f92672">=</span> capacity;
        <span style="color:#66d9ef">this</span><span style="color:#f92672">-&gt;</span>size <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
    }

    <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">get</span>(<span style="color:#66d9ef">int</span> key) {
        <span style="color:#66d9ef">auto</span> umPos <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">-&gt;</span>um.find(key);
        <span style="color:#66d9ef">if</span> (umPos <span style="color:#f92672">==</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">-&gt;</span>um.end()) {
            <span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
        }

        <span style="color:#66d9ef">int</span> value <span style="color:#f92672">=</span> umPos<span style="color:#f92672">-&gt;</span>second<span style="color:#f92672">-&gt;</span>second;

        <span style="color:#66d9ef">this</span><span style="color:#f92672">-&gt;</span>l.erase(umPos<span style="color:#f92672">-&gt;</span>second);
        <span style="color:#66d9ef">this</span><span style="color:#f92672">-&gt;</span>l.push_front(make_pair(key, value));
        <span style="color:#66d9ef">this</span><span style="color:#f92672">-&gt;</span>um.erase(umPos);
        <span style="color:#66d9ef">this</span><span style="color:#f92672">-&gt;</span>um[key] <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">-&gt;</span>l.begin();

        <span style="color:#66d9ef">return</span> value;
    }

    <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">put</span>(<span style="color:#66d9ef">int</span> key, <span style="color:#66d9ef">int</span> value) {
        <span style="color:#75715e">//å…ˆæœç´¢, å¦‚æœæ‰¾åˆ°åˆ é™¤
</span><span style="color:#75715e"></span>        <span style="color:#75715e">//å¦‚æœæ²¡æ‰¾åˆ°, åˆ¤æ–­æ˜¯å¦size &gt;= capï¼Œå¦‚æœreachedï¼Œåˆ™åˆ é™¤æœ«å°¾ç»“ç‚¹
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">auto</span> umPos <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">-&gt;</span>um.find(key);
        <span style="color:#66d9ef">if</span> (umPos <span style="color:#f92672">!=</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">-&gt;</span>um.end()) {
            <span style="color:#66d9ef">this</span><span style="color:#f92672">-&gt;</span>l.erase(umPos<span style="color:#f92672">-&gt;</span>second);
            <span style="color:#66d9ef">this</span><span style="color:#f92672">-&gt;</span>um.erase(umPos);
        } <span style="color:#66d9ef">else</span> {
            <span style="color:#66d9ef">if</span> (<span style="color:#66d9ef">this</span><span style="color:#f92672">-&gt;</span>size <span style="color:#f92672">&gt;=</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">-&gt;</span>cap) {
                <span style="color:#66d9ef">this</span><span style="color:#f92672">-&gt;</span>um.erase(<span style="color:#66d9ef">this</span><span style="color:#f92672">-&gt;</span>l.rbegin()<span style="color:#f92672">-&gt;</span>first);
                <span style="color:#66d9ef">this</span><span style="color:#f92672">-&gt;</span>l.pop_back();
            } <span style="color:#66d9ef">else</span> {
                <span style="color:#66d9ef">this</span><span style="color:#f92672">-&gt;</span>size<span style="color:#f92672">++</span>;
            }
        }

        <span style="color:#75715e">//æ–°å€¼æ’å…¥å¤´ç»“ç‚¹ä¸”æ›´æ–°åœ¨æ•£åˆ—è¡¨ä¸­çš„ä½ç½®
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">this</span><span style="color:#f92672">-&gt;</span>l.push_front(make_pair(key, value));
        <span style="color:#66d9ef">this</span><span style="color:#f92672">-&gt;</span>um[key] <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">-&gt;</span>l.begin();
    }
};

<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>()
{
    <span style="color:#66d9ef">auto</span> cache <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> LRUCache(<span style="color:#ae81ff">2</span>);

    cout <span style="color:#f92672">&lt;&lt;</span> cache<span style="color:#f92672">-&gt;</span>get(<span style="color:#ae81ff">2</span>) <span style="color:#f92672">&lt;&lt;</span> endl;
    cache<span style="color:#f92672">-&gt;</span>put(<span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">6</span>);
    cout <span style="color:#f92672">&lt;&lt;</span> cache<span style="color:#f92672">-&gt;</span>get(<span style="color:#ae81ff">1</span>) <span style="color:#f92672">&lt;&lt;</span> endl;
    cache<span style="color:#f92672">-&gt;</span>put(<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">5</span>);
    cache<span style="color:#f92672">-&gt;</span>put(<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">2</span>);
    cout <span style="color:#f92672">&lt;&lt;</span> cache<span style="color:#f92672">-&gt;</span>get(<span style="color:#ae81ff">1</span>) <span style="color:#f92672">&lt;&lt;</span> endl;
    cout <span style="color:#f92672">&lt;&lt;</span> cache<span style="color:#f92672">-&gt;</span>get(<span style="color:#ae81ff">2</span>) <span style="color:#f92672">&lt;&lt;</span> endl;

    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
}
</code></pre></div><p>ä¸ªäººè§‰å¾—è¿™é“é¢˜å¹¶ä¸èƒ½ç®—ä¸ŠMediumçš„éš¾åº¦ï¼Œå†™å®Œä»¥åæ‰“è„¸äº†ï¼Œè¿™é“é¢˜å¹¶ä¸æ˜¯éš¾åœ¨æ€è·¯ï¼Œéš¾åœ¨ä»£ç é‡ä¸Šï¼Œæˆ‘ç‰¹æ„ç”¨ç§’è¡¨è®¡äº†ä¸ªæ—¶ï¼Œæ ‡å‡†çš„50è¡Œä»£ç 20åˆ†é’Ÿå†…ç™½æ¿ä¸Šbugfreeï¼ŒåŸºäºè¿™ä¸ªèƒŒæ™¯ç¡®å®å¾ˆç¬¦åˆMediuméš¾åº¦ã€‚</p>
<h3 id="redis-lruçš„å®ç°">
  Redis LRUçš„å®ç°
  <a class="anchor" href="#redis-lru%e7%9a%84%e5%ae%9e%e7%8e%b0">#</a>
</h3>

    </div>
  </article>

  <script src="https://giscus.app/client.js"
    data-repo='JustZyx/giscus-comments'
    data-repo-id='R_kgDOHvFCsw'
    data-category="General"
    data-category-id='DIC_kwDOHvFCs84CSSli'
    data-mapping="title"
    data-strict="1"
    data-reactions-enabled="1"
    data-emit-metadata="1"
    data-input-position="bottom"
    data-theme="light_tritanopia"
    data-lang="zh-CN"
    data-loading="lazy"
    crossorigin="anonymous"
    async>
</script>

</main>

      <footer class="footer">
        <ul class="footer-links">
          <section class="copyright">
            <a href="https://blog.justzyx.cn">åº„å…¨ğŸ¥š</a> Â© 2016 - 2022 | <a href="http://beian.miit.gov.cn" target="_blank">è‹ICPå¤‡19052852å·-1</a>
          </section>
        </ul>
      </footer>
    </div>

    
  </body>
</html>
